<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HackBox - Docker VM</title>
    <link rel="stylesheet" href="styles.css">
    <!-- xterm.js for terminal emulation -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.19.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@4.19.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.4.0/lib/xterm-addon-web-links.js"></script>
</head>
<body>
    <div class="docker-vm-container">
        <div class="docker-vm-header">
            <h1>HackBox Docker VM</h1>
            <div class="controls">
                <a href="index.html">Back to Home</a>
                <button id="logout-btn" class="btn-logout">Logout</button>
            </div>
        </div>
        
        <div id="auth-container" class="auth-container">
            <h2>Docker VM Authentication</h2>
            <div id="auth-error" class="error-message" style="display: none;"></div>
            <form id="auth-form" class="auth-form">
                <div class="form-group">
                    <label for="auth-token">Authentication Token</label>
                    <input
                        type="password"
                        id="auth-token"
                        placeholder="Enter your Docker VM token"
                        required
                    />
                </div>
                <button type="submit" class="btn-primary">Login</button>
                <div class="demo-notice mt-4">
                    <p>Demo Mode: Enter any value as token to see the demo interface</p>
                </div>
            </form>
        </div>
        
        <div id="vm-container" style="display: none;">
            <div class="vm-status-bar">
                <div class="vm-info">
                    <span class="vm-name" id="vm-name">Ubuntu LXDE</span>
                    <span class="vm-status-badge stopped" id="vm-status">Stopped</span>
                </div>
                <div class="vm-controls">
                    <button id="start-vm-btn" class="btn-success">Start VM</button>
                    <button id="stop-vm-btn" class="btn-danger" style="display: none;">Stop VM</button>
                </div>
            </div>
            
            <div class="docker-vm-tabs">
                <div class="tab active" data-tab="terminal">Terminal</div>
                <div class="tab" data-tab="desktop">Desktop</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>
            
            <div class="docker-vm-content">
                <div id="loading-overlay" class="loading-overlay" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div id="loading-message">Loading...</div>
                </div>
                
                <!-- Terminal tab -->
                <div class="tab-content active" id="terminal-tab">
                    <div class="terminal-container" id="terminal-container">
                        <div class="terminal-header">
                            <div class="terminal-title">Docker VM Terminal</div>
                            <div class="terminal-controls">
                                <button id="restart-terminal-btn" class="btn-secondary btn-sm">Restart Terminal</button>
                            </div>
                        </div>
                        <div class="terminal" id="terminal"></div>
                    </div>
                </div>
                
                <!-- Desktop tab -->
                <div class="tab-content" id="desktop-tab">
                    <div class="desktop-frame" id="desktop-frame">
                        <div class="desktop-header">
                            <div class="desktop-title">Docker VM Desktop</div>
                            <div class="desktop-controls">
                                <button id="fullscreen-btn" class="btn-secondary btn-sm">Fullscreen</button>
                            </div>
                        </div>
                        <iframe id="desktop-iframe" src="about:blank" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
                
                <!-- Settings tab -->
                <div class="tab-content" id="settings-tab">
                    <div class="settings-container">
                        <h2>VM Settings</h2>
                        
                        <div class="vm-selection">
                            <h3>Select VM Image</h3>
                            <div class="vm-options" id="vm-options">
                                <!-- VM options will be loaded here -->
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                        
                        <div class="vm-resources mt-4">
                            <h3>Resource Allocation</h3>
                            <div class="form-group">
                                <label for="cpu">CPU Cores</label>
                                <select id="cpu">
                                    <option value="1">1 Core</option>
                                    <option value="2" selected>2 Cores</option>
                                    <option value="4">4 Cores</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="memory">Memory</label>
                                <select id="memory">
                                    <option value="512">512 MB</option>
                                    <option value="1024" selected>1 GB</option>
                                    <option value="2048">2 GB</option>
                                    <option value="4096">4 GB</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="storage">Storage</label>
                                <select id="storage">
                                    <option value="5">5 GB</option>
                                    <option value="10" selected>10 GB</option>
                                    <option value="20">20 GB</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="vm-actions mt-4">
                            <button id="apply-settings-btn" class="btn-primary">Apply Settings</button>
                            <p class="settings-note">
                                Note: Settings can only be changed when the VM is stopped.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let terminal = null;
        let fitAddon = null;
        let vmStatus = 'stopped';
        let selectedVM = 'ubuntu-lxde';
        let authToken = '';
        let vmId = null;
        let activeTab = 'terminal';
        
        // DOM elements
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const vmContainer = document.getElementById('vm-container');
        const vmNameElement = document.getElementById('vm-name');
        const vmStatusElement = document.getElementById('vm-status');
        const startVMBtn = document.getElementById('start-vm-btn');
        const stopVMBtn = document.getElementById('stop-vm-btn');
        const restartTerminalBtn = document.getElementById('restart-terminal-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const terminalElement = document.getElementById('terminal');
        const desktopIframe = document.getElementById('desktop-iframe');
        const vmOptionsContainer = document.getElementById('vm-options');
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already authenticated
            const savedToken = localStorage.getItem('dockerVMAuthToken');
            if (savedToken) {
                authToken = savedToken;
                authenticateUser();
            }
            
            // Set up auth form
            authForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const token = document.getElementById('auth-token').value;
                if (!token) {
                    showAuthError('Authentication token is required');
                    return;
                }
                
                authToken = token;
                localStorage.setItem('dockerVMAuthToken', token);
                authenticateUser();
            });
            
            // Set up logout button
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Set up tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // Set up VM control buttons
            startVMBtn.addEventListener('click', startVM);
            stopVMBtn.addEventListener('click', stopVM);
            restartTerminalBtn.addEventListener('click', restartTerminal);
            
            // Set up settings button
            document.getElementById('apply-settings-btn').addEventListener('click', applySettings);
            
            // Set up fullscreen button
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
        });
        
        // Authenticate user
        function authenticateUser() {
            showLoading('Authenticating...');
            
            // Call the Netlify function to validate the token
            fetch('/.netlify/functions/docker-proxy/status?token=' + authToken)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Authentication failed');
                    }
                    return response.json();
                })
                .then(data => {
                    // Show VM container
                    authContainer.style.display = 'none';
                    vmContainer.style.display = 'block';
                    
                    // Load VM templates
                    loadVMTemplates();
                    
                    // Initialize terminal
                    initTerminal();
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                    showAuthError('Authentication failed. Please check your token and try again.');
                    localStorage.removeItem('dockerVMAuthToken');
                    hideLoading();
                });
        }
        
        // Load VM templates
        function loadVMTemplates() {
            showLoading('Loading VM templates...');
            
            // Call the Netlify function to get VM templates
            fetch('/.netlify/functions/docker-proxy/vm/templates?token=' + authToken)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load VM templates');
                    }
                    return response.json();
                })
                .then(data => {
                    // Render VM templates
                    vmOptionsContainer.innerHTML = '';
                    
                    const templates = data.templates || {};
                    Object.keys(templates).forEach(templateId => {
                        const template = templates[templateId];
                        const isSelected = templateId === selectedVM;
                        
                        const templateElement = document.createElement('div');
                        templateElement.className = `vm-option ${isSelected ? 'selected' : ''}`;
                        templateElement.setAttribute('data-template-id', templateId);
                        templateElement.innerHTML = `
                            <div class="vm-option-icon">${getVMIcon(templateId)}</div>
                            <div class="vm-option-details">
                                <h4>${template.name}</h4>
                                <p>${template.description}</p>
                            </div>
                        `;
                        
                        templateElement.addEventListener('click', function() {
                            selectVMTemplate(templateId);
                        });
                        
                        vmOptionsContainer.appendChild(templateElement);
                    });
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading VM templates:', error);
                    vmOptionsContainer.innerHTML = '<div class="error-message">Failed to load VM templates</div>';
                    hideLoading();
                });
        }
        
        // Select VM template
        function selectVMTemplate(templateId) {
            selectedVM = templateId;
            
            // Update UI
            document.querySelectorAll('.vm-option').forEach(option => {
                if (option.getAttribute('data-template-id') === templateId) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Update VM name
            fetch('/.netlify/functions/docker-proxy/vm/templates?token=' + authToken)
                .then(response => response.json())
                .then(data => {
                    const templates = data.templates || {};
                    const template = templates[templateId];
                    if (template) {
                        vmNameElement.textContent = template.name;
                    }
                })
                .catch(error => {
                    console.error('Error updating VM name:', error);
                });
        }
        
        // Initialize terminal
        function initTerminal() {
            if (!terminalElement) return;
            
            // Create terminal if it doesn't exist
            if (!terminal) {
                terminal = new Terminal({
                    cursorBlink: true,
                    theme: {
                        background: '#1e1e1e',
                        foreground: '#f0f0f0'
                    },
                    fontSize: 14,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    scrollback: 1000
                });
                
                // Create fit addon
                fitAddon = new FitAddon.FitAddon();
                terminal.loadAddon(fitAddon);
                
                // Create web links addon
                const webLinksAddon = new WebLinksAddon.WebLinksAddon();
                terminal.loadAddon(webLinksAddon);
                
                // Open terminal
                terminal.open(terminalElement);
                fitAddon.fit();
                
                // Handle resize
                window.addEventListener('resize', function() {
                    if (fitAddon) {
                        fitAddon.fit();
                    }
                });
            }
            
            // Clear terminal
            terminal.clear();
            
            // Write welcome message
            terminal.writeln('Welcome to HackBox Docker VM Terminal');
            terminal.writeln('');
            
            if (vmStatus === 'running') {
                terminal.writeln('Connected to VM. Type commands to interact with the VM.');
                terminal.writeln('');
                terminal.write('root@hackbox:~# ');
                
                // Set up terminal input handling
                setupTerminalInput();
            } else {
                terminal.writeln('VM is not running. Start the VM to access the terminal.');
                terminal.writeln('');
            }
        }
        
        // Set up terminal input handling
        function setupTerminalInput() {
            if (!terminal) return;
            
            // Remove existing data listeners
            terminal._core.onData.clear();
            
            let currentLine = '';
            
            terminal.onData(function(data) {
                // Handle backspace
                if (data === '\u007f') {
                    if (currentLine.length > 0) {
                        currentLine = currentLine.slice(0, -1);
                        terminal.write('\b \b');
                    }
                    return;
                }
                
                // Handle enter
                if (data === '\r') {
                    terminal.writeln('');
                    executeCommand(currentLine);
                    currentLine = '';
                    return;
                }
                
                // Handle normal input
                terminal.write(data);
                currentLine += data;
            });
        }
        
        // Execute command in terminal
        function executeCommand(command) {
            if (!command.trim()) {
                terminal.write('root@hackbox:~# ');
                return;
            }
            
            // In a real implementation, this would send the command to the VM via WebSocket
            // For demo purposes, we'll simulate command execution
            
            const cmd = command.trim().toLowerCase();
            
            if (cmd === 'help' || cmd === 'h') {
                terminal.writeln('Available commands:');
                terminal.writeln('  help     - Show this help message');
                terminal.writeln('  ls       - List files');
                terminal.writeln('  pwd      - Print working directory');
                terminal.writeln('  whoami   - Show current user');
                terminal.writeln('  date     - Show current date and time');
                terminal.writeln('  clear    - Clear the terminal');
                terminal.writeln('  ip       - Show IP address');
                terminal.writeln('  ps       - List processes');
                terminal.writeln('  free     - Show memory usage');
                terminal.writeln('  df       - Show disk usage');
                terminal.writeln('  uname    - Show system information');
                terminal.writeln('  exit     - Exit the terminal');
            } else if (cmd === 'ls') {
                terminal.writeln('Documents  Downloads  Pictures  Videos');
                terminal.writeln('Desktop    Music      Public    hackbox.txt');
            } else if (cmd === 'pwd') {
                terminal.writeln('/root');
            } else if (cmd === 'whoami') {
                terminal.writeln('root');
            } else if (cmd === 'date') {
                terminal.writeln(new Date().toString());
            } else if (cmd === 'clear') {
                terminal.clear();
            } else if (cmd === 'ip' || cmd === 'ifconfig') {
                terminal.writeln('eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500');
                terminal.writeln('        inet 192.168.1.100  netmask 255.255.255.0  broadcast 192.168.1.255');
                terminal.writeln('        inet6 fe80::215:5dff:fe00:1  prefixlen 64  scopeid 0x20<link>');
                terminal.writeln('        ether 00:15:5d:00:00:01  txqueuelen 1000  (Ethernet)');
                terminal.writeln('        RX packets 1234  bytes 1234567 (1.2 MB)');
                terminal.writeln('        RX errors 0  dropped 0  overruns 0  frame 0');
                terminal.writeln('        TX packets 1234  bytes 1234567 (1.2 MB)');
                terminal.writeln('        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0');
            } else if (cmd === 'ps' || cmd === 'ps aux') {
                terminal.writeln('USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND');
                terminal.writeln('root         1  0.0  0.1   8940  3716 ?        Ss   00:00   0:01 /sbin/init');
                terminal.writeln('root         2  0.0  0.0      0     0 ?        S    00:00   0:00 [kthreadd]');
                terminal.writeln('root         3  0.0  0.0      0     0 ?        I<   00:00   0:00 [rcu_gp]');
                terminal.writeln('root         4  0.0  0.0      0     0 ?        I<   00:00   0:00 [rcu_par_gp]');
                terminal.writeln('root         6  0.0  0.0      0     0 ?        I<   00:00   0:00 [kworker/0:0H-kblockd]');
                terminal.writeln('root         9  0.0  0.0      0     0 ?        I<   00:00   0:00 [mm_percpu_wq]');
                terminal.writeln('root        10  0.0  0.0      0     0 ?        S    00:00   0:00 [ksoftirqd/0]');
                terminal.writeln('root        11  0.0  0.0      0     0 ?        I    00:00   0:00 [rcu_sched]');
                terminal.writeln('root        12  0.0  0.0      0     0 ?        S    00:00   0:00 [migration/0]');
                terminal.writeln('root        13  0.0  0.0      0     0 ?        S    00:00   0:00 [cpuhp/0]');
                terminal.writeln('root        14  0.0  0.0      0     0 ?        S    00:00   0:00 [cpuhp/1]');
                terminal.writeln('root        15  0.0  0.0      0     0 ?        S    00:00   0:00 [migration/1]');
                terminal.writeln('root        16  0.0  0.0      0     0 ?        S    00:00   0:00 [ksoftirqd/1]');
                terminal.writeln('root       123  0.0  0.3  23456  9876 ?        Ss   00:00   0:00 /usr/sbin/sshd -D');
                terminal.writeln('root       456  0.0  0.2  34567  8765 ?        Ss   00:00   0:00 /usr/sbin/apache2 -k start');
            } else if (cmd === 'free' || cmd === 'free -h') {
                terminal.writeln('              total        used        free      shared  buff/cache   available');
                terminal.writeln('Mem:          1.0Gi       256Mi       512Mi        64Mi       256Mi       768Mi');
                terminal.writeln('Swap:         1.0Gi          0B       1.0Gi');
            } else if (cmd === 'df' || cmd === 'df -h') {
                terminal.writeln('Filesystem      Size  Used Avail Use% Mounted on');
                terminal.writeln('/dev/sda1       10G   3.5G   6.5G  35% /');
                terminal.writeln('tmpfs           512M     0  512M   0% /dev/shm');
                terminal.writeln('tmpfs           512M  6.1M  506M   2% /run');
                terminal.writeln('tmpfs           512M     0  512M   0% /sys/fs/cgroup');
                terminal.writeln('/dev/sda15      124M   12M  113M  10% /boot/efi');
                terminal.writeln('tmpfs           102M     0  102M   0% /run/user/0');
            } else if (cmd === 'uname' || cmd === 'uname -a') {
                terminal.writeln('Linux hackbox 5.15.0-58-generic #64-Ubuntu SMP x86_64 GNU/Linux');
            } else if (cmd === 'exit') {
                terminal.writeln('Closing terminal session...');
                setTimeout(function() {
                    terminal.clear();
                    terminal.writeln('Terminal session closed.');
                    terminal.writeln('');
                    terminal.writeln('Click "Restart Terminal" to start a new session.');
                }, 1000);
                return;
            } else if (cmd === 'cat hackbox.txt') {
                terminal.writeln('Welcome to HackBox Docker VM!');
                terminal.writeln('');
                terminal.writeln('This is a Docker VM running in your browser.');
                terminal.writeln('You can use it for cybersecurity training, development, and more.');
                terminal.writeln('');
                terminal.writeln('Enjoy your hacking experience!');
            } else if (cmd.startsWith('cat ')) {
                terminal.writeln('cat: ' + cmd.substring(4) + ': No such file or directory');
            } else if (cmd.startsWith('cd ')) {
                terminal.writeln('Changed directory to ' + cmd.substring(3));
            } else if (cmd.startsWith('mkdir ')) {
                terminal.writeln('Directory created: ' + cmd.substring(6));
            } else if (cmd.startsWith('touch ')) {
                terminal.writeln('File created: ' + cmd.substring(6));
            } else if (cmd.startsWith('rm ')) {
                terminal.writeln('File removed: ' + cmd.substring(3));
            } else if (cmd.startsWith('echo ')) {
                terminal.writeln(cmd.substring(5));
            } else {
                terminal.writeln('bash: ' + cmd + ': command not found');
            }
            
            terminal.write('root@hackbox:~# ');
        }
        
        // Start VM
        function startVM() {
            showLoading('Starting VM...');
            
            // Update UI
            vmStatus = 'starting';
            updateVMStatus();
            
            // Call the Netlify function to start the VM
            fetch(`/.netlify/functions/docker-proxy/vm/start?id=${vmId || selectedVM}&token=${authToken}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to start VM');
                    }
                    return response.json();
                })
                .then(data => {
                    vmId = data.id;
                    vmStatus = data.status;
                    updateVMStatus();
                    
                    // Initialize terminal
                    initTerminal();
                    
                    // Load desktop
                    loadDesktop();
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error starting VM:', error);
                    alert('Failed to start VM: ' + error.message);
                    vmStatus = 'stopped';
                    updateVMStatus();
                    hideLoading();
                });
        }
        
        // Stop VM
        function stopVM() {
            if (!confirm('Are you sure you want to stop the VM?')) {
                return;
            }
            
            showLoading('Stopping VM...');
            
            // Call the Netlify function to stop the VM
            fetch(`/.netlify/functions/docker-proxy/vm/stop?id=${vmId || selectedVM}&token=${authToken}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to stop VM');
                    }
                    return response.json();
                })
                .then(data => {
                    vmStatus = data.status;
                    updateVMStatus();
                    
                    // Update terminal
                    if (terminal) {
                        terminal.clear();
                        terminal.writeln('VM stopped. Start the VM to access the terminal.');
                        terminal.writeln('');
                    }
                    
                    // Clear desktop
                    desktopIframe.src = 'about:blank';
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error stopping VM:', error);
                    alert('Failed to stop VM: ' + error.message);
                    hideLoading();
                });
        }
        
        // Update VM status UI
        function updateVMStatus() {
            // Update status badge
            vmStatusElement.textContent = vmStatus.charAt(0).toUpperCase() + vmStatus.slice(1);
            vmStatusElement.className = 'vm-status-badge ' + vmStatus;
            
            // Update VM control buttons
            if (vmStatus === 'stopped') {
                startVMBtn.style.display = 'block';
                stopVMBtn.style.display = 'none';
                document.getElementById('apply-settings-btn').disabled = false;
            } else if (vmStatus === 'running') {
                startVMBtn.style.display = 'none';
                stopVMBtn.style.display = 'block';
                document.getElementById('apply-settings-btn').disabled = true;
            } else {
                startVMBtn.style.display = 'none';
                stopVMBtn.style.display = 'block';
                stopVMBtn.disabled = true;
                document.getElementById('apply-settings-btn').disabled = true;
                setTimeout(function() {
                    stopVMBtn.disabled = false;
                }, 3000);
            }
        }
        
        // Restart terminal
        function restartTerminal() {
            if (vmStatus !== 'running') {
                alert('VM must be running to restart the terminal');
                return;
            }
            
            initTerminal();
        }
        
        // Load desktop
        function loadDesktop() {
            if (vmStatus !== 'running') {
                desktopIframe.src = 'about:blank';
                return;
            }
            
            showLoading('Loading desktop...');
            
            // Call the Netlify function to get desktop connection info
            fetch(`/.netlify/functions/docker-proxy/vm/desktop?id=${vmId || selectedVM}&token=${authToken}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to get desktop connection');
                    }
                    return response.json();
                })
                .then(data => {
                    // In a real implementation, this would connect to a noVNC server
                    // For demo purposes, we'll load a simulated desktop
                    
                    // Set iframe source to a placeholder
                    desktopIframe.src = 'about:blank';
                    
                    // Show loading message in iframe
                    const iframeDoc = desktopIframe.contentDocument || desktopIframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <style>
                                body {
                                    background-color: #2b2b2b;
                                    color: white;
                                    font-family: Arial, sans-serif;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                    height: 100vh;
                                    margin: 0;
                                }
                                .desktop-demo {
                                    width: 800px;
                                    height: 600px;
                                    background-color: #333;
                                    border-radius: 8px;
                                    overflow: hidden;
                                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                                    display: flex;
                                    flex-direction: column;
                                }
                                .desktop-demo-header {
                                    background-color: #444;
                                    padding: 4px 8px;
                                    display: flex;
                                    justify-content: space-between;
                                }
                                .desktop-demo-title {
                                    font-size: 14px;
                                }
                                .desktop-demo-controls {
                                    display: flex;
                                }
                                .desktop-demo-control {
                                    width: 16px;
                                    height: 16px;
                                    border-radius: 50%;
                                    margin-left: 8px;
                                    cursor: pointer;
                                }
                                .desktop-demo-control:nth-child(1) {
                                    background-color: #ff5f56;
                                }
                                .desktop-demo-control:nth-child(2) {
                                    background-color: #ffbd2e;
                                }
                                .desktop-demo-control:nth-child(3) {
                                    background-color: #27c93f;
                                }
                                .desktop-demo-content {
                                    flex: 1;
                                    display: flex;
                                    background-image: url('https://i.imgur.com/8rqUBtV.jpg');
                                    background-size: cover;
                                    position: relative;
                                }
                                .desktop-demo-sidebar {
                                    width: 60px;
                                    background-color: rgba(0, 0, 0, 0.7);
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    padding-top: 10px;
                                }
                                .desktop-demo-icon {
                                    width: 40px;
                                    height: 40px;
                                    background-color: rgba(255, 255, 255, 0.1);
                                    border-radius: 4px;
                                    margin-bottom: 10px;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    font-size: 20px;
                                    cursor: pointer;
                                }
                                .desktop-demo-icon:hover {
                                    background-color: rgba(255, 255, 255, 0.2);
                                }
                                .desktop-demo-window {
                                    position: absolute;
                                    top: 50px;
                                    left: 100px;
                                    width: 500px;
                                    height: 300px;
                                    background-color: #222;
                                    border-radius: 6px;
                                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                                    overflow: hidden;
                                    display: flex;
                                    flex-direction: column;
                                }
                                .desktop-demo-window-header {
                                    background-color: #333;
                                    padding: 8px;
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                }
                                .desktop-demo-window-title {
                                    font-size: 14px;
                                }
                                .desktop-demo-window-close {
                                    cursor: pointer;
                                }
                                .desktop-demo-window-content {
                                    flex: 1;
                                    padding: 10px;
                                    font-family: monospace;
                                    font-size: 14px;
                                    color: #0f0;
                                    overflow: auto;
                                }
                                .desktop-demo-footer {
                                    height: 30px;
                                    background-color: rgba(0, 0, 0, 0.7);
                                    display: flex;
                                    align-items: center;
                                    padding: 0 10px;
                                }
                                .desktop-demo-start {
                                    background-color: #E95420;
                                    color: white;
                                    padding: 2px 10px;
                                    border-radius: 3px;
                                    margin-right: 10px;
                                    font-size: 12px;
                                    cursor: pointer;
                                }
                                .desktop-demo-taskbar {
                                    flex: 1;
                                    display: flex;
                                    align-items: center;
                                }
                                .desktop-demo-task {
                                    background-color: rgba(255, 255, 255, 0.1);
                                    padding: 2px 10px;
                                    border-radius: 3px;
                                    margin-right: 5px;
                                    font-size: 12px;
                                }
                                .desktop-demo-time {
                                    font-size: 12px;
                                }
                                .message {
                                    margin-top: 20px;
                                    text-align: center;
                                    max-width: 600px;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="desktop-demo">
                                <div class="desktop-demo-header">
                                    <div class="desktop-demo-title">${vmNameElement.textContent} Desktop</div>
                                    <div class="desktop-demo-controls">
                                        <div class="desktop-demo-control"></div>
                                        <div class="desktop-demo-control"></div>
                                        <div class="desktop-demo-control"></div>
                                    </div>
                                </div>
                                <div class="desktop-demo-content">
                                    <div class="desktop-demo-sidebar">
                                        <div class="desktop-demo-icon">🖥️</div>
                                        <div class="desktop-demo-icon">📁</div>
                                        <div class="desktop-demo-icon">🌐</div>
                                        <div class="desktop-demo-icon">📝</div>
                                        <div class="desktop-demo-icon">⚙️</div>
                                    </div>
                                    <div class="desktop-demo-window">
                                        <div class="desktop-demo-window-header">
                                            <div class="desktop-demo-window-title">Terminal</div>
                                            <div class="desktop-demo-window-close">✕</div>
                                        </div>
                                        <div class="desktop-demo-window-content">
                                            <pre>Welcome to ${vmNameElement.textContent}!

root@hackbox:~# ls
Documents  Downloads  Pictures  Videos
Desktop    Music      Public    hackbox.txt

root@hackbox:~# cat hackbox.txt
Welcome to HackBox Docker VM!

This is a Docker VM running in your browser.
You can use it for cybersecurity training, development, and more.

Enjoy your hacking experience!

root@hackbox:~# _</pre>
                                        </div>
                                    </div>
                                </div>
                                <div class="desktop-demo-footer">
                                    <div class="desktop-demo-start">Start</div>
                                    <div class="desktop-demo-taskbar">
                                        <div class="desktop-demo-task">Terminal</div>
                                    </div>
                                    <div class="desktop-demo-time" id="desktop-time"></div>
                                </div>
                            </div>
                            <div class="message">
                                <p>This is a real-time view of your Docker VM's desktop environment.</p>
                                <p>In a full implementation, this would be a noVNC connection to your Docker container.</p>
                            </div>
                            
                            <script>
                                // Update time
                                function updateTime() {
                                    document.getElementById('desktop-time').textContent = new Date().toLocaleTimeString();
                                }
                                updateTime();
                                setInterval(updateTime, 1000);
                            </script>
                        </body>
                        </html>
                    `);
                    iframeDoc.close();
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading desktop:', error);
                    alert('Failed to load desktop: ' + error.message);
                    hideLoading();
                });
        }
        
        // Apply settings
        function applySettings() {
            if (vmStatus !== 'stopped') {
                alert('VM must be stopped to apply settings');
                return;
            }
            
            const cpuCores = document.getElementById('cpu').value;
            const memory = document.getElementById('memory').value;
            const storage = document.getElementById('storage').value;
            
            showLoading('Applying settings...');
            
            // Call the Netlify function to create/update the VM
            fetch('/.netlify/functions/docker-proxy/vm/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    template: selectedVM,
                    cpus: cpuCores,
                    memory: memory,
                    storage: storage,
                    token: authToken
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to apply settings');
                    }
                    return response.json();
                })
                .then(data => {
                    vmId = data.id;
                    alert('Settings applied successfully');
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error applying settings:', error);
                    alert('Failed to apply settings: ' + error.message);
                    hideLoading();
                });
        }
        
        // Toggle fullscreen
        function toggleFullscreen() {
            if (desktopIframe) {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    desktopIframe.requestFullscreen();
                }
            }
        }
        
        // Switch tab
        function switchTab(tab) {
            activeTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(el => {
                if (el.getAttribute('data-tab') === tab) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(el => {
                if (el.id === tab + '-tab') {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
            
            // Initialize terminal if needed
            if (tab === 'terminal' && vmStatus === 'running') {
                initTerminal();
            }
            
            // Load desktop if needed
            if (tab === 'desktop' && vmStatus === 'running') {
                loadDesktop();
            }
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('dockerVMAuthToken');
            authToken = '';
            vmStatus = 'stopped';
            vmId = null;
            
            // Reset UI
            authContainer.style.display = 'block';
            vmContainer.style.display = 'none';
            document.getElementById('auth-token').value = '';
            
            // Clear terminal
            if (terminal) {
                terminal.dispose();
                terminal = null;
            }
            
            // Clear desktop
            desktopIframe.src = 'about:blank';
        }
        
        // Show auth error
        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }
        
        // Show loading overlay
        function showLoading(message) {
            loadingMessage.textContent = message || 'Loading...';
            loadingOverlay.style.display = 'flex';
        }
        
        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        // Get VM icon
        function getVMIcon(templateId) {
            const icons = {
                'ubuntu-lxde': '🖥️',
                'kali-linux': '🛡️',
                'parrot-sec': '🦜'
            };
            return icons[templateId] || '🖥️';
        }
    </script>
</body>
</html>